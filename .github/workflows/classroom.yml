name: AutoGrading Tests
on:
  - push
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'oracle'
          java-version: '23'
      - name: Download JavaFX
        run: |
          wget https://download2.gluonhq.com/openjfx/23.0.1/openjfx-23.0.1_linux-x64_bin-sdk.zip
          unzip -q openjfx-23.0.1_linux-x64_bin-sdk.zip -d ${{ github.workspace }}
          mv ${{ github.workspace }}/javafx-sdk-23.0.1 ${{ github.workspace }}/javafx-sdk

      - name: Download JUnit Platform Console
        run: |
          mkdir -p lib
          wget -q https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.11.4/junit-platform-console-standalone-1.11.4.jar -O lib/junit-platform-console-standalone.jar

      - name: Download Mockito & Byte‚ÄëBuddy
        run: |
          wget -q https://repo1.maven.org/maven2/org/mockito/mockito-core/5.18.0/mockito-core-5.18.0.jar \
               -O lib/mockito-core-5.18.0.jar

          # Byte‚ÄêBuddy runtime & agent
          wget -q https://repo1.maven.org/maven2/net/bytebuddy/byte-buddy/1.17.5/byte-buddy-1.17.5.jar \
               -O lib/byte-buddy-1.17.5.jar
          wget -q https://repo1.maven.org/maven2/net/bytebuddy/byte-buddy-agent/1.17.5/byte-buddy-agent-1.17.5.jar \
               -O lib/byte-buddy-agent-1.17.5.jar

      - name: Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: CheckStyle
        id: checkstyle
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: CheckStyle
          setup-command: |
            wget --no-verbose https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.23.1/checkstyle-10.23.1-all.jar
            wget --no-verbose https://csse.msoe.us/csc1110/MSOE_checkStyle.xml
          command: |
            java -jar checkstyle-10.23.1-all.jar \
            -c MSOE_checkStyle.xml \
            -e src/test/*.java src/**/*.java
          timeout: 10

      - name: Compile Java code
        run: |
          mkdir -p bin
          javac -cp "lib/*:${{ github.workspace }}/javafx-sdk/lib/*" \
                --module-path ${{ github.workspace }}/javafx-sdk/lib/ \
                --add-modules javafx.controls,javafx.fxml \
                -d bin src/**/*.java

      - name: Unit Tests
        id: unit-tests
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: Unit Tests
          setup-command: |
            mkdir -p bin
            javac -cp "lib/*:${{ github.workspace }}/javafx-sdk/lib/*" \
                --module-path ${{ github.workspace }}/javafx-sdk/lib/ \
                --add-modules javafx.controls,javafx.fxml \
                -d bin src/**/*.java
          command: |
            # pull the full commit message
            COMMIT_MSG='${{ github.event.head_commit.message }}'

            # if it starts with COMMIT<digits> or DONE<digits>, grab that first word as the tag
            case "$COMMIT_MSG" in
              COMMIT[0-9]*|DONE[0-9]*)
                TAG="${COMMIT_MSG%% *}"
                echo "üîñ Detected tag: $TAG"
                TAG_ARGS="--include-tag $TAG"
               ;;
              *)
                echo "‚ñ∂Ô∏è No valid COMMIT<n> or DONE<n> tag found; running all tests"
                TAG_ARGS=""
                ;;
            esac
            # Fakes display for the headless running of FX
            xvfb-run --auto-servernum --server-args="-screen 0 1024x768x24" \
              java \
                -Djava.awt.headless=true \
                -Dprism.order=sw \
                -Dprism.text=t2k \
                -Djavafx.platform=Monocle \
                -Dmonocle.platform=Headless \
                -cp "bin:lib/*:${{ github.workspace }}/javafx-sdk/lib/*" \
                --module-path ${{ github.workspace }}/javafx-sdk/lib/ \
                --add-modules javafx.controls,javafx.fxml \
                --add-opens javafx.graphics/com.sun.javafx.util=ALL-UNNAMED \
                --add-opens javafx.graphics/com.sun.glass.ui=ALL-UNNAMED \
                --add-opens javafx.graphics/com.sun.javafx.application=ALL-UNNAMED \
                --add-opens javafx.base/com.sun.javafx.logging=ALL-UNNAMED \
                --add-exports javafx.graphics/com.sun.javafx.tk=ALL-UNNAMED \
                --add-exports javafx.graphics/com.sun.javafx.scene=ALL-UNNAMED \
                --add-exports javafx.graphics/com.sun.javafx.scene.layout=ALL-UNNAMED \
                --add-exports javafx.base/com.sun.javafx.event=ALL-UNNAMED \
                --add-exports javafx.base/com.sun.javafx.logging=ALL-UNNAMED \
                org.junit.platform.console.ConsoleLauncher execute \
                $TAG_ARGS \
                --scan-class-path \
                --class-path bin
        timeout-minutes: 5

      - name: AutoGrading Reporter
        uses: classroom-resources/autograding-grading-reporter@v1
        env:
          CHECKSTYLE_RESULTS: "${{steps.checkstyle.outputs.result}}"
          UNIT-TESTS_RESULTS: "${{steps.unit-tests.outputs.result}}"
        with:
          runners: checkstyle,unit-tests